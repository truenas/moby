#!/usr/bin/make -f

export DH_VERBOSE = 1
VERSION ?= $(shell cat VERSION)
TARGET_ARCH = $(shell dpkg-architecture -qDEB_TARGET_ARCH)
# export AUTO_GOPATH=1
export GOPROXY=direct
export GO111MODULE=off
export GOPATH=/go
export GOROOT=/usr/local/go
# export PATH=$PATH:/usr/local/go/bin

# force packages to be built with xz compression, as Ubuntu 21.10 and up use
# zstd compression, which is non-standard, and breaks 'dpkg-sig --verify'
override_dh_builddeb:
	dh_builddeb -- -Zxz

override_dh_auto_clean:

override_dh_auto_build:
	# install go 1.16
	curl https://dl.google.com/go/go1.16.4.linux-amd64.tar.gz -o /tmp/go.tar.gz
	tar -C /tmp -xvf /tmp/go.tar.gz
	mv /tmp/go /usr/local/
	ln -s /usr/local/go/bin/go /usr/bin/go
	# export PATH=$GOROOT/bin:$PATH

	# Build the daemon and dependencies
	mkdir -p /go/src/github.com/docker
	ln -snf /dpkg-src /go/src/github.com/docker/docker
	DOCKER_GITCOMMIT=$(ENGINE_GITCOMMIT) PRODUCT=docker ./hack/make.sh dynbinary
	TMP_GOPATH="/go" hack/dockerfile/install/install.sh tini
	TMP_GOPATH="/go" hack/dockerfile/install/install.sh proxy dynamic
	TMP_GOPATH="/go" hack/dockerfile/install/install.sh rootlesskit dynamic

override_dh_auto_test:

override_dh_strip:
	# Go has lots of problems with stripping, so just don't

override_dh_auto_install:
	# docker-ce install
	install -D -m 0644 contrib/init/systemd/docker.service debian/docker-ce/lib/systemd/system/docker.service
	install -D -m 0644 contrib/init/systemd/docker.socket debian/docker-ce/lib/systemd/system/docker.socket
	install -D -m 0755 $(shell readlink -e bundles/dynbinary-daemon/dockerd) debian/docker-ce/usr/bin/dockerd
	install -D -m 0755 /usr/local/bin/docker-proxy debian/docker-ce/usr/bin/docker-proxy
	install -D -m 0755 /usr/local/bin/docker-init debian/docker-ce/usr/bin/docker-init

	# docker-ce-rootless-extras install
	install -D -m 0755 /usr/local/bin/rootlesskit debian/docker-ce-rootless-extras/usr/bin/rootlesskit
	install -D -m 0755 /usr/local/bin/rootlesskit-docker-proxy debian/docker-ce-rootless-extras/usr/bin/rootlesskit-docker-proxy
	install -D -m 0755 contrib/dockerd-rootless.sh debian/docker-ce-rootless-extras/usr/bin/dockerd-rootless.sh
	install -D -m 0755 contrib/dockerd-rootless-setuptool.sh debian/docker-ce-rootless-extras/usr/bin/dockerd-rootless-setuptool.sh
	# TODO: how can we install vpnkit?

override_dh_installinit:
	# use "docker" as our service name, not "docker-ce"
	dh_installinit --name=docker

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_install:
	dh_install
	# TODO Can we do this from within our container?
	dh_apparmor --profile-name=docker-ce -pdocker-ce

override_dh_gencontrol:
	dh_gencontrol --remaining-packages

%:
	dh $@ --with=bash-completion
